# Что нужно, чтобы писать юнит тесты.

(Этот документ пока больше похож на черновик, буду по мере наличия времени приводить его в порядок и расширять)

* Чтобы легко было писать юнит тесты, - нужно писать очень модульный код, т.е. любой логически отделимый алгоритм выделять в отдельную функцию.

* Не все системы подходят для Unit тестов.
Если сильно связанная система, где куча спагетти - кода, то придется делать UI тесты,
API тесты, или общие тесты на контроллеры, а затем, под защитой этих регрессионных тестов - делать мега-рефакторинги и Юнит - тесты. Новый код нужно писать тестабельным. Подробней тут: https://www.youtube.com/watch?v=ZC_GH4AANqc.

* Т.е. тесты должны быть как можно короче и узконаправленней. Чем больше разного кода задействует тест, тем чаще он будет ломаться при изменениях.

* Данные для тестов нужно хранить отдельно от кода тестов. Перед каждым тестом хорошо бы проверять какой-то внешний environment и наличие данных теста.

* Если хочется написать комментарии для какого-то куска кода - выделяй его в отдельную ф-ю, с информативным названием. Скорее всего, комменты тогда не понадобятся.

* Всякие Роберты Мартины и Мартины Фаулеры вообще рекомендуют не более 10 строчек кода на функцию.
Из здравого смысла есть ориентиры в 1 экран. Если ваша ф-я больше 2х экранов - это плохой код.

TODO: Хорошо бы сделать авточекер - насчет длины функций. Т.е. не пропускать коммиты с длинными функциями.

* Особого смысла делать self-invoking функции в node.js модулях нет. Если делать обычные функции, то будет "засоряться" (именами функций) только локальная область видимости модуля. И с обычными функциями (пусть даже приватными для модуля) не надо извращаться при их юнит - тестировании.

* Обычно Юнит тесты легко пишутся для функций, рассчитывающих и преобразовывающих данные. Тогда легко проверить, что для заданных входов есть заданные выходы.

* К сожалению. У нас таких функций для расчета и преобразоавния мало (парсинг и маппинг в интеграциях, шифрование, преобразование разных форматов данных).


## Тестирование ф-й, работающих с БД.

* Большинство наших функций - это помещение чего-то в БД, и извлечение чего-то из БД.

* Теоретически, можно было бы отделить ф-и, формирующие запрос к БД, от ф-й, исполняющих этот запрос, и в юнит тестах завести некие эталонные строки запроса, с которыми сравнивать реальные строки запроса. Но, такие тесты крайне тяжело писать и поддерживать. При малейшем рефакторинге запроса, не влияющем на результат - нужно править тест. И ещё такие тесты ненадежны, в них человек оценивает правильность эталонной строки запросов, а не конкретные изменения в БД.

* Таким образом остается вариант - тестировать на реальной БД. Т.е. устанавливать требуемый тесты пресет данных перед тестом, и проверять состояние БД после вызова ф-й. Но, не завершать транзакцию во время теста, а после теста - отменять транзакцию. Есть хороший доклад на эту тему тут: https://www.youtube.com/watch?v=5hBOIJfve2o



## Принципы успешных систем автотестирования.

Резюме доклада отсюда: 
https://www.youtube.com/watch?v=R6oNWAP6jec

* Тесты должны легко работать из коробки. Тестировщик любого уровня должен иметь возможность запускать тесты.

* Желательно даже, чтобы писать тесты было очень просто, и это могли делать тестировщики. Причем, важно собирать фидбэки от тестировщиков, пишущих тесты.

* Важно иметь документацию на инструменты тестирования. Инструкцию для людей, запускающих тесты. Инструкцию, для людей, пишущих тесты.

* Важно чтобы были удобные отчеты. Для тестировщиков, для программистов, для менеджеров.

* Обязательно раз в несколько месяцев делать ревизию всех тестов.

* Не очень хорошая практика тестировать новый функционал через GUI?
Почему ? Возможно потому, что новый функционал вводится итеграциями, правится.
Вот когда он станет стабильным - тогда имеет смысл GUI тестирование.


## Мокирование.

* http://sinonjs.org/releases/v4.1.3/
* https://github.com/sinonjs/lolex
* https://github.com/jhnns/rewire
* https://github.com/mfncooper/mockery


### Модуль от русского парня.

* https://github.com/theKashey/rewiremock
* https://habrahabr.ru/post/339590/
* https://habrahabr.ru/post/329740/#comment_10258456


## Тестирование и мокирование приватных функций.

* https://stackoverflow.com/questions/22097603/unit-testing-of-private-functions-with-mocha-and-node-js
* https://philipwalton.com/articles/why-i-test-private-functions-in-javascript/
* https://philipwalton.com/articles/how-to-unit-test-private-functions-in-javascript/
* https://github.com/jhnns/rewire


TODO: покрытие + закинуть другие резюме статей и докладов сюда.
